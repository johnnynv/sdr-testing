# 错误处理与智能提示测试用例 (REQ-02)

## 测试目标
验证系统能够智能处理不完整或错误的查询，提供有用的提示和自动纠正，提升用户体验。

---

## 测试组 1: 缺少通道号

### TC-1.1: 完全缺少通道号
**输入查询：** `Summarize the last 10 minutes`
**期待结果：**
- 系统识别缺少通道信息
- 返回提示：**"请指定通道号，例如：channel 0, channel 1, 或 channel 2"**
- 或者：自动查询所有通道并说明
- 响应时间 < 5秒
- 不应返回错误，而是友好建议

### TC-1.2: 有时间和动作，缺少通道
**输入查询：** `What topics were discussed in the past hour?`
**期待结果：**
- 识别缺少通道信息
- 返回提示：**"可用通道：channel 0, 1, 2。请指定一个通道"**
- 或者：默认查询所有通道并明确说明
- 响应时间 < 5秒

### TC-1.3: 非常模糊的查询
**输入查询：** `Show me recent transcripts`
**期待结果：**
- 识别缺少通道和具体时间
- 返回提示：**"请指定：1) 通道号（0-2）2) 时间范围（如：最近10分钟）"**
- 提供查询示例
- 响应时间 < 3秒

---

## 测试组 2: 缺少时间信息

### TC-2.1: 有通道，缺时间
**输入查询：** `What was discussed on channel 0?`
**期待结果：**
- 识别缺少时间范围
- 返回提示：**"请指定时间范围，例如：'最近10分钟'，'过去1小时'，'15分钟前'"**
- 或者：默认使用最近一段时间（如最近10分钟）并说明
- 响应时间 < 5秒

### TC-2.2: 仅指定通道
**输入查询：** `Summarize channel 2`
**期待结果：**
- 识别缺少时间信息
- 返回提示：**"请添加时间范围，例如：'Summarize channel 2 from the last hour'"**
- 提供完整查询示例
- 响应时间 < 3秒

### TC-2.3: 模糊的时间表述
**输入查询：** `What was discussed on channel 1 recently?`
**期待结果：**
- 识别"recently"过于模糊
- **选项A：** 自动解释为"最近10-15分钟"并明确说明
- **选项B：** 询问用户："'recently'是指最近5分钟、10分钟还是30分钟？"
- 响应时间 < 5秒

### TC-2.4: 使用"old"等模糊词
**输入查询：** `Show me old transcripts from channel 2`
**期待结果：**
- 识别"old"不明确
- 返回提示：**"请指定具体时间，例如：'1小时前'，'30分钟前'，或时间范围"**
- 响应时间 < 3秒

---

## 测试组 3: 格式错误

### TC-3.1: 词序错误
**输入查询：** `channel 0 what last 10 minutes`
**期待结果：**
- **最佳：** 系统自动理解并纠正为 "What happened on channel 0 in the last 10 minutes"
- **次佳：** 提示："您是否想问：'Summarize the last 10 minutes on channel 0'？"
- 仍然尝试返回结果
- 响应时间 < 5秒

### TC-3.2: 拼写错误
**输入查询：** `Summerize channal 0 from last our`
**期待结果：**
- 系统自动纠正：
  - "Summerize" → "Summarize"
  - "channal" → "channel"
  - "our" → "hour"
- **理想：** 显示纠正后的查询并返回结果
- **示例响应：** "理解您的查询为：'Summarize channel 0 from last hour'，结果如下：..."
- 响应时间 < 5秒

### TC-3.3: 使用缩写
**输入查询：** `What happened on ch 3 recently?`
**期待结果：**
- 识别"ch"为"channel"的缩写
- 识别"channel 3"不存在（只有0-2）
- 返回提示：**"系统有 channel 0, 1, 2。您是否想查询其中一个？"**
- 响应时间 < 3秒

### TC-3.4: 错误术语
**输入查询：** `What was discussed on stream 2 in the past hour?`
**期待结果：**
- 识别"stream"应为"channel"
- **最佳：** 自动纠正并说明："理解为 'channel 2'"
- 返回 channel 2 的结果
- 响应时间 < 5秒

---

## 测试组 4: 无效值

### TC-4.1: 无效通道号（超出范围）
**输入查询：** `Summarize channel 5 from the last 10 minutes`
**期待结果：**
- 识别 channel 5 不存在
- 返回明确提示：**"Channel 5 不存在。可用通道：0, 1, 2"**
- 建议：**"您是否想查询 channel 0, 1 或 2？"**
- 响应时间 < 3秒

### TC-4.2: 负数通道
**输入查询：** `What was on channel -1 fifteen minutes ago?`
**期待结果：**
- 识别负数通道无效
- 返回提示：**"通道号应为 0, 1 或 2"**
- 响应时间 < 3秒

### TC-4.3: 无效时间格式（25:00）
**输入查询：** `What was discussed at 25:00 on channel 0?`
**期待结果：**
- 识别 25:00 无效（小时应为 0-23）
- 返回提示：**"时间格式错误。请使用如 '14:30' 或相对时间如 '30分钟前'"**
- 提供正确示例
- 响应时间 < 3秒

### TC-4.4: 负数时间范围
**输入查询：** `Summarize the last -10 minutes on channel 0`
**期待结果：**
- 识别负数时间无效
- **最佳：** 自动纠正为正数："理解为'最近10分钟'"
- **次佳：** 返回提示："时间不能为负数，请使用正数"
- 响应时间 < 3秒

---

## 测试组 5: 极度模糊的查询

### TC-5.1: 极短查询
**输入查询：** `what?`
**期待结果：**
- 识别查询过于简单
- 返回友好引导：**"我可以帮您查询音频转录内容。请尝试：**
  - **'Summarize the last 10 minutes on channel 0'**
  - **'What was discussed on channel 1 in the past hour?'**
  - **'Show me recent topics on channel 2'"**
- 响应时间 < 3秒

### TC-5.2: 单个动词
**输入查询：** `show`
**期待结果：**
- 识别信息不足
- 返回引导：**"请补充信息，例如：**
  - **Show me [时间] on [通道]**
  - **示例：'Show me the last 5 minutes on channel 0'"**
- 响应时间 < 3秒

### TC-5.3: 仅数字
**输入查询：** `0`
**期待结果：**
- 识别可能指 channel 0
- 返回引导：**"您是否想查询 channel 0？请添加时间范围，例如：**
  - **'Summarize channel 0 from the last 10 minutes'"**
- 响应时间 < 3秒

### TC-5.4: 无意义字符串
**输入查询：** `asdfghjkl`
**期待结果：**
- 识别为无效输入
- 返回友好提示：**"无法理解您的查询。查询格式示例：**
  - **[动作] [时间] on [通道]**
  - **如：'Summarize the last hour on channel 1'"**
- 提供帮助链接或文档
- 响应时间 < 3秒

---

## 测试组 6: 智能提示验证

### TC-6.1: 混合错误（多个问题）
**输入查询：** `summerize channal last our`
**期待结果：**
- 识别多个错误：拼写错误 + 缺少通道号
- 自动纠正拼写
- 询问通道号：**"请指定通道 (0, 1, 或 2)"**
- 响应时间 < 5秒

### TC-6.2: 部分正确的查询
**输入查询：** `Last 10 minutes channel`
**期待结果：**
- 识别词序问题和缺少通道号
- **建议纠正：** "Summarize the last 10 minutes on channel [0/1/2]"
- 询问选择哪个通道
- 响应时间 < 3秒

### TC-6.3: 使用"给我"等口语化表达
**输入查询：** `给我看看 channel 0 最近的`
**期待结果：**
- 识别混合语言和口语化表达
- **最佳：** 理解意图并返回结果
- 提示："理解为'显示 channel 0 最近的内容'，默认查询最近10分钟"
- 响应时间 < 5秒

---

## 期待的智能行为总结

| 错误类型 | 系统应该做什么 | 不应该做什么 |
|---------|--------------|-------------|
| **缺少信息** | 明确指出缺少什么，提供选项 | 直接报错退出 |
| **拼写错误** | 自动纠正，显示纠正结果 | 说"无法理解" |
| **词序错误** | 智能解析，理解意图 | 严格要求语法 |
| **无效值** | 说明有效范围，提供替代 | 仅说"错误" |
| **模糊查询** | 提供具体示例，引导用户 | 拒绝处理 |

---

## 错误消息质量标准

好的错误消息应该包含：

1. ✅ **明确说明问题**：什么地方出错了
2. ✅ **提供解决方案**：如何修正
3. ✅ **给出示例**：正确的查询格式
4. ✅ **保持友好**：不使用技术术语
5. ✅ **可操作**：用户能直接使用建议

### 示例对比

❌ **差的错误消息：**
```
Error: Invalid query format
```

✅ **好的错误消息：**
```
无法找到通道信息。请指定通道号（0, 1 或 2）。

示例：
- "Summarize the last 10 minutes on channel 0"
- "What was discussed on channel 1 in the past hour?"
```

---

## 成功标准

对于每个测试用例，系统应该：

1. **识别率 > 90%**：正确识别查询中的问题
2. **建议有用性**：提供的建议能直接解决问题
3. **响应友好度**：不使用"错误"、"失败"等负面词汇
4. **完整性**：提供足够信息让用户修正查询
5. **可用性**：即使有错误也尽量返回部分结果（在合理的情况下）

---

## 快速测试命令

```bash
# 运行错误处理完整测试套件
cd /localhome/keystone/jupyter_workspace/sdr-testing/qa-tests
source venv/bin/activate
xvfb-run -a --server-args="-screen 0 1920x1080x24" python3 test_rag_error_handling.py

# 查看测试报告
ls -lt error_handling_report_*.json | head -1

# 查看截图
ls -lt screenshots/error_* | head -10
```

---

## 附录：测试覆盖矩阵

| 测试组 | 测试用例数 | 覆盖场景 |
|-------|-----------|---------|
| 缺少通道号 | 3 | TC-1.1 ~ TC-1.3 |
| 缺少时间信息 | 4 | TC-2.1 ~ TC-2.4 |
| 格式错误 | 4 | TC-3.1 ~ TC-3.4 |
| 无效值 | 4 | TC-4.1 ~ TC-4.4 |
| 极度模糊 | 4 | TC-5.1 ~ TC-5.4 |
| 智能提示 | 3 | TC-6.1 ~ TC-6.3 |
| **总计** | **22** | **全面覆盖** |

